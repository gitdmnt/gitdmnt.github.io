---
import Common from "../../layouts/Common.astro";
import Md from "../../layouts/Md.astro";
import { Temporal } from "temporal-polyfill";

// dynamic routing
export async function getStaticPaths() {
  const posts = Object.values(
    import.meta.glob("/src/content/article/*.{md,mdx}", { eager: true })
  ) as Array<any>;

  return posts.map((p) => {
    const filename = p.file.split("/").pop()?.split(".")[0] ?? "";
    return { params: { article: filename } };
  });
}
const { article } = Astro.params;
const content = Object.values(
  import.meta.glob("/src/content/article/*.{md,mdx}", { eager: true })
);
const page: any = content.find((p: Record<string, any>) => {
  return p.file.split("/").pop().split(".")[0] === article;
});

const { frontmatter } = page;

// 日付を正規化するユーティリティ
function isoDateFrom(value: any) {
  if (!value) return undefined;
  const d = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(d.getTime())) return undefined;
  return d.toISOString().slice(0, 10);
}
const iso = isoDateFrom(frontmatter.date ?? frontmatter.pubDate);
const displayDate = iso ? Temporal.PlainDate.from(iso).toString() : "";

/* markdownlint-disable */
---

<Common
  url={Astro.url.href}
  type="article"
  title={frontmatter.title}
  description={frontmatter.description}
  image={frontmatter.thumbnail}
>
  <h1>{frontmatter.title}</h1>
  <Md>
    <page.Content />
  </Md>
  <p class="credit">
    {displayDate}, 書いた人: {frontmatter.author ?? "不明"}
  </p>

  <a
    href="https://twitter.com/share?ref_src=twsrc%5Etfw"
    class="twitter-share-button"
    data-text={frontmatter.title + "\n" + (frontmatter.description ?? "")}
    data-url={Astro.url.href}
    data-dnt="true"
    data-show-count="false">Tweet</a
  >
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"
  ></script>

  <!-- KaTeX -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
    integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"
    crossorigin="anonymous"
  />

  <!-- The loading of KaTeX is deferred to speed up page rendering -->
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
    integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
    crossorigin="anonymous"></script>

  <!-- To automatically render math in text elements, include the auto-render extension: -->
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
    crossorigin="anonymous"
    onload="renderMathInElement(document.body, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '$', right: '$', display: false }
        ],
      });"
  ></script>
</Common>

<style>
  .h1 {
    white-space: wrap;
  }
  .credit {
    color: rgb(189, 189, 189);
    font-size: 10pt;
  }
</style>
